{% extends 'base.html' %}
{% block title %}Normal{% endblock %}
{% block head %}
<style>
    table, th{
        border: 1px gainsboro solid;
        border-collapse: collapse;
    }
    tr, td {
        border-inline: 1px gainsboro solid;
        border-collapse: collapse;
        text-align: center;
    }
</style>
{% endblock %}
{% block content %}
    <h1>ลงทะเบียนเรียน</h1>

    <section>
        <table>
            <thead>
                <tr>
                    <th class="p-1"></th>
                    <th class="p-1" colspan="4">08:00-09:00</th>
                    <th class="p-1" colspan="4">09:00-10:00</th>
                    <th class="p-1" colspan="4">10:00-11:00</th>
                    <th class="p-1" colspan="4">11:00-12:00</th>
                    <th class="p-1" colspan="4">12:00-13:00</th>
                    <th class="p-1" colspan="4">13:00-14:00</th>
                    <th class="p-1" colspan="4">14:00-15:00</th>
                    <th class="p-1" colspan="4">15:00-16:00</th>
                    <th class="p-1" colspan="4">16:00-17:00</th>
                    <th class="p-1" colspan="4">17:00-18:00</th>
                    <th class="p-1" colspan="4">18:00-19:00</th>
                    <th class="p-1" colspan="4">19:00-20:00</th>
                </tr>
            </thead>
            <tbody id="schedule">
                <tr id="table_mon">
                    <td class="p1">Mon</td>
                </tr>
                <tr id="table_tue">
                    <td class="p1">Tue</td>
                </tr>
                <tr id="table_wed">
                    <td class="p1">Wed</td>
                </tr>
                <tr id="table_thu">
                    <td class="p1">Thu</td>
                </tr>
                <tr id="table_fri">
                    <td class="p1">Fri</td>
                </tr>
                <tr id="table_sat">
                    <td class="p1">Sat</td>
                </tr>
                <tr id="table_sun">
                    <td class="p1">Sun</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section>
        <table>
            <thead>
                <tr >
                    <th>รหัส</th>
                    <th>วิชา</th>
                    <th>หน่วยกิต</th>
                    <th>ผู้สอน</th>
                    <th>กลุ่ม</th>
                    <th>เวลาเรียน</th>
                    <th>สถานที่</th>
                    <th>รับ</th>
                    <th>ลง</th>
                    <th>ลบ</th>
                </tr>
            </thead>
            <tbody id="queues">
            </tbody>
        </table>
        <button onclick="submit()">ยืนยัน</button>
    </section>

    <section>
        <input id="inputcode" type="text" class="border border-amber-400 rounded-2xl bg-white">
        <button onclick="toQueues(event)" id="inputbutton">เพิ่ม</button>
    </section>

    <section>
        <table>
            <thead>
                <tr>
                    <th>รหัสวิชา</th>
                    <th>ชื่อวิชา</th>
                    <th>หน่วยกิต</th>
                </tr>
            </thead>
            <tbody id="courses">
                {% for course in courses %}
                <tr id="{{ course.code }}" class="cursor-pointer" onclick="toQueues(event)">
                    <td>{{ course.code }}</td>
                    <td>{{ course.name }}</td>
                    <td>{{ course.credits }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
{% endblock %}

{% block script %}
<script>
    window.addEventListener("load", load);

    function load() {
        localStorage.clear();
        resetSchedule();
    }

    async function toQueues(event) {
        const id = event.currentTarget.id;
        var code = ""
        if (id === "inputbutton") {
            const input = document.getElementById("inputcode");
            code = input.value
        } else {
            code = id
        }

        if (code === "") return

        const queues = document.getElementById("queues");
        for (c=0; c<queues.children.length; c++) {
            if (queues.children[c].id === code) return
        }
        const url = `/courses/api/detail/${code}`;
        fetch(url)
        .then(response => response.json())
        .then(data => {
            localStorage.setItem(data.code, JSON.stringify(data))
            const queues = document.getElementById("queues")
            const new_course = document.createElement('tr')
            new_course.setAttribute("id", data.code)
            var professors = ""
            data.professors.forEach(pro => {professors += `${pro.user.title} ${pro.user.first_name} ${pro.user.last_name}\n`})
            new_course.innerHTML = `<td>${data.code}</td><td>${data.name}</td><td>${data.credits}</td><td>${professors}</td>`
            const td = document.createElement('td')
            const select = document.createElement('select')
            select.setAttribute("id", `${data.code}_section`)
            select.setAttribute("onchange", "changeSection(event)")
            const option = document.createElement('option')
            option.setAttribute("value", '-')
            option.innerText = "-"
            select.appendChild(option)
            data.sections.forEach(section => {
                const option = document.createElement('option')
                option.setAttribute("value", section.number)
                option.innerText = section.number
                select.appendChild(option)
            })
            td.appendChild(select)
            new_course.appendChild(td)
            new_course.innerHTML += `<td>-</td><td>-</td><td>-</td><td>-</td><td><button class="cursor-pointer bg-red-500" onclick="remove(event, ${data.code})">ลบ</button></td>`
            queues.appendChild(new_course)
        })
        .catch(error => console.error('Error:', error));
    }
    function changeSection(event) {
        const course = event.target.parentElement.parentElement
        const data = localStorage.getItem(course.id)
        const obj = JSON.parse(data)

        const section = obj.sections.find(s => s.number === Number(event.target.value));
        if (!section) {
            course.children[5].innerText = "-";
            course.children[6].innerText = "-";
            course.children[7].innerText = "-";
            resetSchedule()
            return;
        }

        const newTimes = section.classes.map(c => ({
            day: c.day,
            start: c.start_time,
            end: c.end_time,
        }));

        const queues = document.getElementById("queues");
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        for (let i = 0; i < queues.children.length; i++) {
            const row = queues.children[i];
            if (row.id === course.id) continue;

            const timeText = row.children[5].innerText.trim();
            if (timeText === '-') continue;
            const times = timeText.split("\n").filter(t => t.trim() !== "");

            for (const t of times) {
                const [day, range] = t.split(" ");
                const [start, end] = range.split("-");
                for (const newT of newTimes) {
                    if (newT.day === day && isOverlap(start, end, newT.start, newT.end)) {
                        alert(`เวลาทับกับรายวิชา ${row.id}`);
                        event.target.value = "-";
                        course.children[5].innerText = "-";
                        course.children[6].innerText = "-";
                        course.children[7].innerText = "-";
                        resetSchedule()
                        return;
                    }
                }
            }
        }
        

        obj.sections.forEach(section => {
            if (section.number === Number(event.target.value)) {
                var time = ""
                var location = ""
                section.classes.forEach(aclass => {
                    time += `${aclass.day} ${aclass.start_time}-${aclass.end_time}\n`
                    location += `${aclass.location}\n`
                })
                course.children[5].innerText = time;
                course.children[6].innerText = location;
                course.children[7].innerText = section.capacity;
            }
        })
        resetSchedule()
    }

    function remove(event, code) {
        localStorage.removeItem(code)
        event.target.parentElement.parentElement.remove()
        resetSchedule()
    }
    
    function submit() {
        const queues = document.getElementById("queues")
        if (queues.children.length === 0) {
            return alert("โปรดเลือกวิชาก่อน")
        }
        var codes = ""
        for (i=0; i<queues.children.length; i++) {
            if (queues.children[i].children[4].children[0].value === '-') {
                alert(`โปรดเลือก section ของรหัสวิชา ${queues.children[i].id}`)
                return
            }
            const text = queues.children[i].id + "_" + queues.children[i].children[4].children[0].value
            codes += text + ","
        }
        const url = `/enroll/api/submit/${codes}`;
        console.log(url)
        fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.text !== "Success") {
                return alert(data.text)
            }
            alert(data.text)
            return window.location.href = "{% url 'home' %}"
        })
    }

    function resetSchedule() {
        const colors = [
            '#EF4444',
            '#F59E0B',
            '#10B981',
            '#3B82F6',
            '#8B5CF6',
            '#EC4899',
            '#14B8A6',
            '#F97316',
            '#84CC16',
            '#06B6D4',
            '#6366F1',
            '#22C55E',
            ];
        const tbody = document.getElementById("schedule");
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        for (let d = 0; d < days.length; d++) {
            const tr = tbody.children[d];
            tr.innerHTML = `<td class="p1">${days[d]}</td>`;
            for (let t = 0; t < 48; t++) {
                tr.appendChild(document.createElement("td"));
            }
        }

        const queues = document.getElementById("queues");
        for (let i = 0; i < queues.children.length; i++) {
            const row = queues.children[i];
            const section = row.children[4].children[0].value;
            if (section === '-') continue;
            const timeText = row.children[5].innerText.trim();
            const times = timeText.split("\n").filter(t => t.trim() !== "");

            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            times.forEach(time => {
                const [day, hours] = time.split(" ");
                const [start, end] = hours.split("-");
                const dayIndex = days.indexOf(day);
                if (dayIndex === -1) return;

                const [startH, startM] = start.split(":").map(Number);
                const [endH, endM] = end.split(":").map(Number);
                const startTotal = (startH - 8) * 60 + startM;
                const endTotal = (endH - 8) * 60 + endM;

                const startIndex = Math.floor(startTotal / 15) + 1;
                const endIndex = Math.floor(endTotal / 15) + 1;

                const tr = tbody.children[dayIndex];
                const td = tr.children[startIndex];
                if (td) {
                    td.innerText = `${endIndex-startIndex}@${row.children[1].innerText}`;
                    td.style.backgroundColor = randomColor;
                    td.style.color = "white";
                }
            });
        }
        for(d=0; d<tbody.children.length; d++) {
            const day = tbody.children[d]
            for(t=1; t<day.children.length; t++){
                const td = day.children[t]
                if (td.innerText === "") continue
                const duration = td.innerText.split("@")
                td.innerText = duration[1]
                td.setAttribute("colspan", duration[0])
                for (e=1; e<Number(duration[0]); e++) {
                    day.children[t+1].remove()
                }
            }
        }
    }

    function isOverlap(start1, end1, start2, end2) {
        const toMinutes = t => {
            const [h, m] = t.split(":").map(Number);
            return h * 60 + m;
        };
        const s1 = toMinutes(start1);
        const e1 = toMinutes(end1);
        const s2 = toMinutes(start2);
        const e2 = toMinutes(end2);
        return Math.max(s1, s2) < Math.min(e1, e2);
    }

</script>
{% endblock %}